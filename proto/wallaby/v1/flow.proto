syntax = "proto3";

package wallaby.v1;

import "wallaby/v1/types.proto";

option go_package = "github.com/josephjohncox/wallaby/gen/go/wallaby/v1;wallabypb";

service FlowService {
  rpc CreateFlow(CreateFlowRequest) returns (Flow);
  rpc UpdateFlow(UpdateFlowRequest) returns (Flow);
  rpc ReconfigureFlow(ReconfigureFlowRequest) returns (Flow);
  rpc StartFlow(StartFlowRequest) returns (Flow);
  rpc RunFlowOnce(RunFlowOnceRequest) returns (RunFlowOnceResponse);
  rpc StopFlow(StopFlowRequest) returns (Flow);
  rpc ResumeFlow(ResumeFlowRequest) returns (Flow);
  rpc GetFlow(GetFlowRequest) returns (Flow);
  rpc ListFlows(ListFlowsRequest) returns (ListFlowsResponse);
  rpc DeleteFlow(DeleteFlowRequest) returns (DeleteFlowResponse);
  rpc CleanupFlow(CleanupFlowRequest) returns (CleanupFlowResponse);
  rpc ListReplicationSlots(ListReplicationSlotsRequest) returns (ListReplicationSlotsResponse);
  rpc GetReplicationSlot(GetReplicationSlotRequest) returns (GetReplicationSlotResponse);
  rpc DropReplicationSlot(DropReplicationSlotRequest) returns (DropReplicationSlotResponse);
  rpc ListPublicationTables(ListPublicationTablesRequest) returns (ListPublicationTablesResponse);
  rpc AddPublicationTables(AddPublicationTablesRequest) returns (PublicationTablesMutationResponse);
  rpc DropPublicationTables(DropPublicationTablesRequest) returns (PublicationTablesMutationResponse);
  rpc SyncPublicationTables(SyncPublicationTablesRequest) returns (SyncPublicationTablesResponse);
  rpc ScrapePublicationTables(ScrapePublicationTablesRequest) returns (ScrapePublicationTablesResponse);
}

message CreateFlowRequest {
  Flow flow = 1;
  bool start_immediately = 2;
}

message UpdateFlowRequest {
  Flow flow = 1;
}

message ReconfigureFlowRequest {
  Flow flow = 1;
  optional bool pause_first = 2;
  optional bool resume_after = 3;
  optional bool sync_publication = 4;
}

message StartFlowRequest {
  string flow_id = 1;
}

message RunFlowOnceRequest {
  string flow_id = 1;
}

message RunFlowOnceResponse {
  bool dispatched = 1;
}

message StopFlowRequest {
  string flow_id = 1;
}

message ResumeFlowRequest {
  string flow_id = 1;
}

message GetFlowRequest {
  string flow_id = 1;
}

message ListFlowsRequest {
  int32 page_size = 1;
  string page_token = 2;
}

message ListFlowsResponse {
  repeated Flow flows = 1;
  string next_page_token = 2;
}

message DeleteFlowRequest {
  string flow_id = 1;
}

message DeleteFlowResponse {
  bool deleted = 1;
}

message CleanupFlowRequest {
  string flow_id = 1;
  optional bool drop_slot = 2;
  optional bool drop_publication = 3;
  optional bool drop_source_state = 4;
}

message CleanupFlowResponse {
  bool cleaned = 1;
}

message ListReplicationSlotsRequest {
  string flow_id = 1;
  string dsn = 2;
  string slot = 3;
  map<string, string> options = 4;
}

message ReplicationSlotInfo {
  string slot_name = 1;
  string plugin = 2;
  string slot_type = 3;
  string database = 4;
  bool active = 5;
  int32 active_pid = 6;
  bool temporary = 7;
  string wal_status = 8;
  string restart_lsn = 9;
  string confirmed_flush_lsn = 10;
  bool active_pid_present = 11;
}

message ListReplicationSlotsResponse {
  repeated ReplicationSlotInfo slots = 1;
  string flow_id = 2;
}

message GetReplicationSlotRequest {
  string flow_id = 1;
  string dsn = 2;
  string slot = 3;
  map<string, string> options = 4;
}

message GetReplicationSlotResponse {
  ReplicationSlotInfo slot = 1;
}

message DropReplicationSlotRequest {
  string flow_id = 1;
  string dsn = 2;
  string slot = 3;
  bool if_exists = 4;
  map<string, string> options = 5;
}

message DropReplicationSlotResponse {
  string slot = 1;
  bool found = 2;
  bool dropped = 3;
  string flow_id = 4;
}

message ListPublicationTablesRequest {
  string flow_id = 1;
  string dsn = 2;
  string publication = 3;
  map<string, string> options = 4;
}

message ListPublicationTablesResponse {
  repeated string tables = 1;
  string publication = 2;
  string flow_id = 3;
}

message AddPublicationTablesRequest {
  string flow_id = 1;
  string dsn = 2;
  string publication = 3;
  repeated string tables = 4;
  map<string, string> options = 5;
}

message DropPublicationTablesRequest {
  string flow_id = 1;
  string dsn = 2;
  string publication = 3;
  repeated string tables = 4;
  map<string, string> options = 5;
}

message PublicationTablesMutationResponse {
  repeated string tables = 1;
  string publication = 2;
}

message SyncPublicationTablesRequest {
  string flow_id = 1;
  string dsn = 2;
  string publication = 3;
  repeated string tables = 4;
  string mode = 5;
  map<string, string> options = 6;
}

message SyncPublicationTablesResponse {
  repeated string added = 1;
  repeated string removed = 2;
  string publication = 3;
  string flow_id = 4;
}

message ScrapePublicationTablesRequest {
  string flow_id = 1;
  string dsn = 2;
  string publication = 3;
  repeated string schemas = 4;
  bool apply = 5;
  map<string, string> options = 6;
}

message ScrapePublicationTablesResponse {
  repeated string discovered_tables = 1;
  repeated string missing_tables = 2;
  bool applied = 3;
  string flow_id = 4;
}
